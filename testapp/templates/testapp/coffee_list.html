{% extends 'base.html' %}
{% load static %}

{% block title %} Coffee List {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'testapp/css/coffee_list.css' %}">
{% endblock %}

{% block content %}
<section class="card-section">
    <h1 class="section-title">Our Coffees</h1>
    <div id="coffee-container" class="card-container"></div>
</section>

<!-- Toastify is loaded in base.html -->
<script>
/* helper to read CSRF cookie for session fallback */
function getCookie(name) {
    const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
    return v ? decodeURIComponent(v.split('=')[1]) : null;
}

async function loadCoffees() {
    try {
        const response = await fetch("/api/coffees/");
        const coffees = await response.json();
        const container = document.getElementById('coffee-container');
        container.innerHTML = "";

        coffees.forEach(coffee => {
            container.innerHTML += `
                <div class="card">
                    <img src="${coffee.image || '/static/testapp/images/coffeee.jpg'}" alt="${coffee.name}" class="card-img">
                    <h3>${coffee.name}</h3>
                    <p>Flavour: ${coffee.flavour || "Not available"}</p>
                    <p><strong>Price:</strong> â‚¹${coffee.price}</p>
                    <button class="btn" onclick="addToCart(${coffee.id})">Add to Cart</button>
                </div>
            `;
        });
    } catch (e) {
        console.error('Failed to load coffees', e);
    }
}

/* addToCart: JWT flow if token present, otherwise fallback to session view */
async function addToCart(id) {
    const access = localStorage.getItem("access");

    if (access) {
        // JWT API flow
        const res = await fetch("/api/cart/add/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + access
            },
            body: JSON.stringify({ coffee_id: id, quantity: 1 })
        });

        const data = await res.json().catch(() => ({}));
        if (res.ok) {
            Toastify({ text: data.message || "Added to cart", duration: 1200, style: { background: "linear-gradient(#4CAF50,#3aa04a)" } }).showToast();
            if (window.loadCartCount) loadCartCount();
        } else {
            console.error("API add-to-cart failed:", res.status, data);
            Toastify({ text: data.error || "Something went wrong", duration: 1500, style: { background: "red" } }).showToast();
        }
        return;
    }

    // Guest fallback (session-based view)
    const csrftoken = getCookie('csrftoken');
    const res2 = await fetch(`/add-to-cart/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({}) // empty body is fine for session view that uses URL pk
    });

    // Many Django session view redirects to cart; handle
    if (res2.redirected) {
        Toastify({ text: "Added to cart (guest)", duration: 1200, style: { background: "linear-gradient(#4CAF50,#3aa04a)" } }).showToast();
        setTimeout(() => window.location.reload(), 600);
        return;
    }

    // If JSON returned
    const data2 = await res2.json().catch(() => ({}));
    Toastify({ text: data2.message || "Added to cart", duration: 1200, style: { background: "linear-gradient(#4CAF50,#3aa04a)" } }).showToast();
    setTimeout(() => window.location.reload(), 600);
}

/* load cart count (JWT only) */
async function loadCartCount() {
    const access = localStorage.getItem("access");
    const badge = document.getElementById("cart-count");
    if (!badge) return;

    if (!access) {
        // guest - try server-side session count if template prints it (base.html uses 0 fallback)
        return;
    }

    try {
        const response = await fetch("/api/cart/count/", {
            headers: { "Authorization": "Bearer " + access }
        });
        const data = await response.json();
        badge.textContent = data.cart_count ?? 0;
    } catch (e) {
        console.error("Failed to load cart count", e);
    }
}

loadCoffees();
loadCartCount();
</script>
{% endblock %}
