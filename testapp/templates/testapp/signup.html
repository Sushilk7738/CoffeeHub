{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'testapp/css/signup.css' %}">
{% endblock %}

{% block content %}
<div class="signup-container">
    <h2>Create Account</h2>

    <form id="signup-form" class="signup-form">
        <input id="username" type="text" placeholder="Username" required>
        <input id="email" type="email" placeholder="Email" required>
        <input id="password" type="password" placeholder="Password" required>
        <input id="confirm_password" type="password" placeholder="Confirm Password" required>

        <button type="submit">Sign Up</button>
    </form>

    <div class="switch-auth">
        <p>Already have an account? <a href="{% url 'login' %}">Login</a></p>
    </div>
</div>

<script>
document.getElementById("signup-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const confirm_password = document.getElementById("confirm_password").value;

    try {
        const res = await fetch("/api/auth/register/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email, password, confirm_password })
        });

        const data = await res.json();

        if (res.ok) {
            // Save tokens from backend
            localStorage.setItem("access", data.access);
            localStorage.setItem("refresh", data.refresh);

            Toastify({
                text: data.message || "Account created",
                duration: 1500,
                style: { background: "linear-gradient(#4CAF50,#3aa04a)" }
            }).showToast();

            // Update navbar + cart count if available
            if (window.updateNavbarAuth) updateNavbarAuth();
            if (window.loadCartCount) loadCartCount();

            setTimeout(() => window.location.href = "/", 800);
        } else {
            Toastify({
                text: data.error || "Signup failed",
                duration: 1500,
                style: { background: "red" }
            }).showToast();
        }
    } catch (err) {
        Toastify({
            text: "Network error",
            duration: 1500,
            style: { background: "red" }
        }).showToast();
    }
});
</script>
{% endblock %}
